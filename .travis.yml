language: node_js

node_js:
  - 'stable'

# Don't Use container-based Travis infrastructure else we can't get latest Chrome.
sudo: true

env:
  global:
    - BIN="node" ISTANBUL=false OPTION=""
    - NPM_VERSION="^2.0.0""
    - PATTERN1="s|\s*if\s*\(isHostObject\b[\s\S]+?\}(?=\n)||"
    - PATTERN2="s|\s*if\s*\(enumerate\b[\s\S]+?\};\s*\}||"
    - PATTERN3="s|\s*while\s*\([^)]+\)\s*\{\s*iteratee\(index\);\s*\}||"
cache:
  directories:
    - node_modules

matrix:
  include:
    - node_js: "4"
      env:

before_install:
  - "nvm use $TRAVIS_NODE_VERSION"
  - export CHROME_BIN=/usr/bin/google-chrome
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sudo apt-get update
  - sudo apt-get install -y libappindicator1 fonts-liberation
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo dpkg -i google-chrome*.deb
  - "npm config set loglevel error"
  - "npm i -g npm@\"$NPM_VERSION\""
  - "[ $ISTANBUL == false ]   || perl -0pi -e \"$PATTERN1\" ./boily.js"
  - "[ $ISTANBUL == false ]   || perl -0pi -e \"$PATTERN2\" ./boily.js"
  - "[ $ISTANBUL == false ]   || perl -0pi -e \"$PATTERN3\" ./boily.js"
  
install:
  # Log HTTP requests
  - npm config set loglevel http
  - npm install -g npm@3.5.2
   # Instal npm dependecies and ensure that npm cache is not stale
  - npm install
   
notifications:
  email: true
branches:
  except:
    - "/^v\\d+\\.\\d+\\.\\d+$/"

script:
  - "[ $ISTANBUL == false ]   || istanbul cover -x \"**/vendor/**\" --report lcovonly ./test/test.js -- ./dist/boily.js"
  - "[ $ISTANBUL == false ]   || [ $TRAVIS_SECURE_ENV_VARS == false ] || (cat ./coverage/lcov.info | coveralls) || true"