!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.DFP=e.DFP||{})}(this,function(e){"use strict";function t(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=t.separator,n=void 0===i?";":i,r=t.operator,s=void 0===r?"=":r,a={},o=e.split(n);for(var c in o)if(o.hasOwnProperty(c)){var l=o[c].split(s);2==l.length&&(a[l[0]]=decodeURIComponent(l[1]))}return a}function i(){var e=t(document.cookie,{separator:/;\s?/});return"string"==typeof e.tmsso&&(e.tmsso=t(e.tmsso,{separator:":"})),"string"==typeof e.engsso&&(e.engsso=t(e.engsso,{separator:":"})),e}function n(){var e=f.xxl,t=window.innerWidth;return t<f.xl&&(e=f.xl),t<f.l&&(e=f.l),t<f.m&&(e=f.m),t<f.s&&(e=f.s),t<f.xs&&(e=f.xs),t<f.xxs&&(e=f.xxs),e}var r={};r.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var s=window.location.hostname.indexOf("haaretz.com")>-1?"engsso":"tmsso",a={impressions:"impressions",frequency:"frequency",frequencyRegex:/(\d+)\/(\d+)(day|hour)/,expires:"expires",exposed:"exposed",maxImpressions:"maxImpressions",hours:"hour",days:"day"},o=function(){function e(t){r.classCallCheck(this,e),this.now=(new Date).getTime(),this.config=t,this.impressions=JSON.parse(localStorage.getItem(a.impressions)||"{}"),this.initImpressionMap()}return r.createClass(e,[{key:"saveImpressionsToLocalStorage",value:function(){localStorage.setItem(a.impressions,JSON.stringify(this.impressions))}},{key:"initImpressionMap",value:function(){var e=this;Object.keys(this.config).map(function(t,i){var n=t,r=void 0,s=!1;(r=e.impressions[n])?(e.config[n]=!r[a.frequency])?(s=!0,e.impressions[a.frequency]=e.config[n]):e.now>r[a.expires]&&(s=!0):e.initSlotFromConfig(n),s&&e.updateExpiryDate(n)})}},{key:"updateExpiryDate",value:function(e){function t(e,t){var i=new Date(e);return i.setHours(i.getHours()+t),i}function i(e,t){var i=new Date(e);return i.setDate(i.getDate()+t),i}var n=new Date,r=this.impressions[e][a.frequency].match(a.frequencyRegex);n.setMilliseconds(0),n.setSeconds(0),n.setMinutes(0),r.indexOf(a.days)>-1&&n.setHours(0),this.impressions[e][a.expires]=(r.indexOf(a.days)>-1?i(n,r[2]):t(n,r[2])).getTime(),this.impressions[e][a.maxImpressions]=r[1]}},{key:"initSlotFromConfig",value:function(e){var t=this.impressions[e]||{};t[a.frequency]=this.config[e],t[a.exposed]=0,this.impressions[e]=t,this.updateExpiryDate(e)}},{key:"registerImpression",value:function(e){return this.impressions[e][a.exposed]+=1,!0}},{key:"reachedQuota",value:function(e){var t=(new Date).getTime(),i=this.impressions[e][a.maxImpressions];return this.impressions[e][a.expires]<t&&this.impressions[e][a.exposed]<=i}}]),e}(),c={get referrer(){return document.referrer?document.referrer:""},get isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent||"")},get isHomepage(){return"/"===window.location.pathname||3===this.environment},get department(){return this.isHomepage?"_homepage":"_section"},get domain(){var e=/([\d|\w]+)(\.co\.il|\.com)(.*)?/.exec(location.hostname),t=e?e[0]:location.hostname;return t},get path(){return window.location.pathname.split("/").slice(1,-1).map(function(e){return"."+e}).map(function(e,t,i){return i.slice(0,t+1).reduce(function(e,t){return e.concat(t)})})},get environment(){var e={dev:1,test:2,prod:3};return"8080"===window.location.port?e.dev:window.location.hostname.indexOf("pre.haaretz.co.il")>-1||window.location.hostname.indexOf("tmtest.haaretz.com")>-1?e.test:window.location.pathname.indexOf("/cmlink/Haaretz.HomePage")>-1||window.location.pathname.indexOf("/cmlink/TheMarker.HomePage")>-1?e.prod:void 0},get articleId(){var e=/\d\.\d+/g.exec(window.location.pathname),t=void 0;return e&&(t=e.pop()),t},utm_:{get content(){return this.getUrlParam("utm_content")},get source(){return this.getUrlParam("utm_source")},get medium(){return this.getUrlParam("utm_medium")},get campaign(){return this.getUrlParam("utm_campaign")},getUrlParam:function(e){var t=RegExp("("+e+')(=)([^&"]+)').exec(window.location.search);return t&&t[3]?t[3]:void 0}},get gStatCampaignNumber(){var e=window.localStorage.getItem("GstatCampaign")?JSON.parse(window.localStorage.getItem("GstatCampaign")):void 0;return e?e.CampaignNumber:void 0},adSlotConfig:{"haaretz.co.il.example.slot":{id:"slotId",responsive:!0,adSizeMapping:[["width1","height1"]].concat(["widthN","heightN"]),responsiveAdSizeMapping:{xxs:[["width1","height1"]].concat(["widthN","heightN"]),xs:[["width1","height1"]].concat(["widthN","heightN"]),s:[["width1","height1"]].concat(["widthN","heightN"]),m:[["width1","height1"]].concat(["widthN","heightN"]),l:[["width1","height1"]].concat(["widthN","heightN"]),xl:[["width1","height1"]].concat(["widthN","heightN"]),xxl:[["width1","height1"]].concat(["widthN","heightN"])},blacklistReferrers:"comma, delimited, blacklisted, referrer, list",whitelistReferrers:"comma, delimited, referrer, list"}},adManagerConfig:{network:"9401",adUnitBase:"haaretz.co.il_Web"},breakpointsConfig:{get breakpoints(){var e=!0;return e?this.breakpoints1:this.breakpoints2},breakpoints1:{xxs:600,xs:761,s:993,m:1009,l:1291,xl:1600,xxl:1900},breakpoints2:{xxs:600,xs:1e3,s:1150,m:1281,l:1600,xl:1920,xxl:1920}},userConfig:{type:void 0,age:void 0,gender:void 0},sso:s},l={payer:"payer",registered:"registered",anonymous:"anonymous"},u=c,g=function(){function e(t){r.classCallCheck(this,e),this.config=Object.assign({},u,t),this.ssoKey=this.config.userConfig.ssoKey||s;var n=i(this.ssoKey);this.type=this.getUserType(n),this.impressionManager=this.initImpressionMap(),this.age=this.getUserAge(n),this.gender=this.getUserGender(n)}return r.createClass(e,[{key:"getUserType",value:function(e){if(e&&e[this.ssoKey]){var t=window.location.hostname.indexOf("haaretz.com")>-1?"HdcPusr":"HtzPusr";return e[t]?l.payer:l.registered}return l.anonymous}},{key:"getUserAge",value:function(e){var t=void 0,i=e[this.ssoKey]&&e[this.ssoKey].usrae;return i&&(t=parseInt(e[this.ssoKey].usrae),t=t>0?t:void 0),t}},{key:"getUserGender",value:function(e){var t=void 0,i=e[this.ssoKey]&&e[this.ssoKey].urgdr;return i&&(t=parseInt(e[this.ssoKey].urgdr),t=2===t||1===t?t:void 0),t}},{key:"initImpressionMap",value:function(){var e={};return window.adUnitsFrequencyMap&&Object.keys(adUnitsFrequencyMap).map(function(t,i){e[t]=adUnitsFrequencyMap[t]}),new o(e)}}]),e}(),d=function(){function e(){r.classCallCheck(this,e),this.blockingQueue=this.initQueueFromJson()}return r.createClass(e,[{key:"initQueueFromJson",value:function(){var e=[],t=window.conflicManagementJson||window.conflictManagementJson||{};return Object.keys(t).map(function(i,n){var r=t[i];r&&(r=r.filter(function(e){return e.onsize&&e.avoid})),e.push({id:i,rules:r,resolvedWith:null})}),e}},{key:"updateResolvedSlot",value:function(e,t){if(!e)throw new Error("updateResolvedSlot must be called with an adSlotId!");if(!t)throw new Error("updateResolvedSlot must be called with a resolved size!");var i=!0,n=!1,r=void 0;try{for(var s,a=this.blockingQueue[Symbol.iterator]();!(i=(s=a.next()).done);i=!0){var o=s.value;(o.id=e)&&(o.resolvedWith=t)}}catch(e){n=!0,r=e}finally{try{!i&&a.return&&a.return()}finally{if(n)throw r}}}},{key:"isBlocked",value:function e(t){if(!t)throw new Error("isBlocked must be called with an adSlotId!");var e=!1,i=!0,n=!1,r=void 0;try{for(var s,a=this.blockingQueue[Symbol.iterator]();!(i=(s=a.next()).done);i=!0){var o=s.value,c=!0,l=!1,u=void 0;try{for(var g,d=o.rules[Symbol.iterator]();!(c=(g=d.next()).done);c=!0){var h=g.value;h.avoid===t&&!function(){var t=o.resolvedWith;t||(e=!0),h.onsize.split(",").find(function(e){return e===t})&&(e=!0)}()}}catch(e){l=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(l)throw u}}}}catch(e){n=!0,r=e}finally{try{!i&&a.return&&a.return()}finally{if(n)throw r}}return e}}]),e}(),h=function(){function e(t){if(r.classCallCheck(this,e),this.config=Object.assign({},t),this.id=this.config.id,this.type=this.config.type,this.responsive=this.config.responsive,this.adSizeMapping=this.config.adSizeMapping,this.responsiveAdSizeMapping=this.config.responsiveAdSizeMapping,this.blacklistReferrers=this.config.blacklistReferrers,this.whitelistReferrers=this.config.whitelistReferrers,this.lastResolvedSize=null,this.lastResolvedWithBreakpoint=null,!this.config.id)throw new Error("an adSlot requires an id!");this.department=this.config.department,this.target=this.config.target,this.user=this.config.user,console.log(this.config),this.network=this.config.adManagerConfig.network,this.adUnitBase=this.config.adManagerConfig.adUnitBase}return r.createClass(e,[{key:"isOutOfPage",value:function(){switch(this.type){case v.maavaron:return!0;case v.popunder:return!0;case v.talkback:return!0;case v.regular:return!1;default:return!1}}},{key:"isWhitelisted",value:function(){var e=!1;if(0!==this.whitelistReferrers.length){var t=!0,i=!1,n=void 0;try{for(var r,s=this.whitelistReferrers[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var a=r.value;if(c.referrer.indexOf(a)>-1){e=!0;break}}}catch(e){i=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw n}}}else e=!0;return e}},{key:"isBlacklisted",value:function(){var e=!1;if(0!==this.blacklistReferrers.length){var t=!0,i=!1,n=void 0;try{for(var r,s=this.blacklistReferrers[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var a=r.value;if(c.referrer.indexOf(a)>-1){e=!0;break}}}catch(e){i=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw n}}}return e}},{key:"show",value:function(){var e=this;this.type===v.maavaron?this.showMaavaron():googletag.cmd.push(function(){googletag.display(e.id)})}},{key:"defineSlot",value:function(){var e=window.googletag,t=e.pubads(),i=[],n=this.isOutOfPage()?e.defineOutOfPageSlot:e.defineSlot;i.push(this.getPath()),this.isOutOfPage()===!1&&i.push(this.adSizeMapping),i.push(this.id);var r=n.apply(n,i);if(this.responsive){var s=e.sizeMapping(),a=c.breakpointsConfig.breakpoints,o=Object.keys(this.responsiveAdSizeMapping),l=!0,u=!1,g=void 0;try{for(var d,h=o[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var f=d.value;s.addSize([a[f],100],this.responsiveAdSizeMapping[f])}}catch(e){u=!0,g=e}finally{try{!l&&h.return&&h.return()}finally{if(u)throw g}}s=s.build(),r=r.defineSizeMapping(s)}r=r.addService(t),this.isOutOfPage()===!1&&r.setCollapseEmptyDiv(!0),this.slot=r}},{key:"getPath",value:function(){var e=this,t=this.config.path;t=t.map(function(t){return""+e.id+t}).join("/"),t=t?"/"+t:"";var i=this.config.network+"/"+this.config.adUnitBase+"/"+this.id+this.department+t;return console.log("Calculated path : "+i),i}},{key:"slotRendered",value:function(e){e.slot.getAdUnitPath().split("/")[3],e.isEmpty,e.size}},{key:"refresh",value:function(){googletag.pubads().refresh([this.id])}},{key:"showMaavaron",value:function(){if(document.referrer.match("loc.haaretz")===!1){var e=this.getPath(),t=[[2,1]];googletag.pubads().definePassback(e,t).setTargeting("UserType",[this.user.type]).setTargeting("age",[this.user.age]).setTargeting("urgdr",[this.user.gender]).setTargeting("articleId",[this.config.articleId]).setTargeting("stg",[this.config.environment]).display()}}}]),e}(),f=c.breakpointsConfig.breakpoints,p={all:"all",nonPaying:"nonPaying",anonymous:"anonymous",registered:"registered",paying:"paying",digitalOnly:"digitalOnly",digitalAndPrint:"digitalAndPrint"},m={anonymous:"anonymous",registered:"registered",payer:"payer"},v={maavaron:".web.maavaron",popunder:".web.popunder",talkback:".web.fullbanner.talkback",regular:""},y={target:p.all,type:v.regular,responsive:!1,get department(){return c.isHomepage?"homepage":"section"}},w=function(){function e(t){r.classCallCheck(this,e),this.config=Object.assign({},y,t),this.user=new g(t),this.conflictResolver=new d,this.adSlots=this.initAdSlots(),this.initSlotRenderedCallback()}return r.createClass(e,[{key:"showAllSlots",value:function(){var e=!0,t=!1,i=void 0;try{for(var n,r=this.adSlots[Symbol.iterator]();!(e=(n=r.next()).done);e=!0){var s=n.value;this.shouldSendRequestToDfp(s)&&s.show()}}catch(e){t=!0,i=e}finally{try{!e&&r.return&&r.return()}finally{if(t)throw i}}}},{key:"initAdSlots",value:function(e){var t=this,i=[],n=document.getElementsByClassName("js-dfp-ad");return Array.prototype.forEach.call(n,function(e,n){var r=Object.assign({},c.adSlotConfig[e.id],{id:e.id,target:e.attributes["data-audtarget"].value,type:t.getAdType(e.id),responsive:e.classList.contains("js-dfp-resp-refresh"),user:t.user});try{i.push(new h(r))}catch(e){console.log(e)}}),i}},{key:"getAdType",value:function(e){return e.indexOf(v.maavaron)>-1?v.maavaron:e.indexOf(v.popunder)>-1?v.popunder:e.indexOf(v.talkback)>-1?v.talkback:v.regular}},{key:"shouldSendRequestToDfp",value:function(e){return this.conflictResolver.isBlocked(e.id)===!1&&e.isWhitelisted()&&e.isBlacklisted()===!1&&e.isOutOfPage()===!1&&this.doesBreakpointContainAd(e)&&this.doesUserTypeMatchBannerTargeting(e)&&this.user.impressionManager.reachedQuota(e.id)===!1}},{key:"doesUserTypeMatchBannerTargeting",value:function(e){var t=this.user.type,i=e.target;switch(i){case p.all:return!0;case p.nonPaying:return t===m.anonymous||t===m.registered;case p.anonymous:return t===m.anonymous;case p.registered:return t===m.registered;case p.paying:return t===m.payer;case p.digitalOnly:return t===m.payer;case p.digitalAndPrint:return t===m.payer;default:return!1}}},{key:"switchedToBreakpoint",value:function(e){var t=!0,i=!1,n=void 0;try{for(var r,s=this.adSlots[Symbol.iterator]();!(t=(r=s.next()).done);t=!0){var a=r.value;a.responsive===!0}}catch(e){i=!0,n=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw n}}}},{key:"doesBreakpointContainAd",value:function(e){arguments.length<=1||void 0===arguments[1]?n():arguments[1];return!0}},{key:"initSlotRenderedCallback",value:function(){var e=this;if(!window.googletag||!window.googletag.pubadsReady)throw new Error("googletag api was not ready when 'initSlotRenderedCallback' was called!");var t=window.googletag.pubads();t.addEventListener("slotRenderEnded",function(t){var i=t.slot.getAdUnitPath().split("/")[3],r=(t.isEmpty,t.size);e.adSlots[i]&&(e.adSlots[i].lastResolvedSize=r,e.adSlots[i].lastResolvedWithBreakpoint=n())})}},{key:"initGoogleTargetingParams",value:function(){if(!window.googletag||!window.googletag.pubadsReady)throw new Error("googletag api was not ready when 'initGoogleTargetingParams' was called!");var e=googletag.pubads();this.config.environment&&e.setTargeting("stg",[this.config.environment]),this.user.type&&e.setTargeting("UserType",[this.user.type]),this.user.age&&e.setTargeting("age",[this.user.age]),this.user.gender&&e.setTargeting("urgdr",[this.user.gender]),this.config.articleId&&e.setTargeting("articleId",[this.config.articleId]),this.config.gStatCampaignNumber&&-1!=this.config.gStatCampaignNumber&&e.setTargeting("gstat_campaign_id",[this.config.gStatCampaignNumber]),this.config.utm_.content&&e.setTargeting("utm_content",[this.config.utm_.content]),this.config.utm_.source&&e.setTargeting("utm_source",[this.config.utm_.source]),this.config.utm_.medium&&e.setTargeting("utm_medium",[this.config.utm_.medium]),this.config.utm_.campaign&&e.setTargeting("utm_campaign",[this.config.utm_.campaign])}}]),e}(),b=c||{},k=function(){function e(t){r.classCallCheck(this,e),this.config=Object.assign({},b,t),this.wasInitialized=!1}return r.createClass(e,[{key:"resumeInit",value:function(){try{this.adManager=new w(this.config)}catch(e){console.log(e)}}},{key:"initGoogleTag",value:function(){var e=this,t=new Promise(function(t,i){1==e.wasInitialized?t(!0):(window.googletag=window.googletag||{},window.googletag.cmd=window.googletag.cmd||[],function(){var n=window.document.createElement("script");n.async=!0,n.type="text/javascript",n.setAttribute("src","//www.googletagservices.com/tag/js/gpt.js");var r=window.document.getElementsByTagName("script")[0];n.onload=function(){e.wasInitialized=!0,t(!0),e.resumeInit()},n.onerror=function(t){e.wasInitialized=!0,i(t)},r.parentNode.insertBefore(n,r)}())});return t}},{key:"initGoogleGlobalSettings",value:function(){googletag.pubads().enableAsyncRendering(),googletag.enableServices()}}]),e}();k.version="0.0.2";var x=new k(c);e.dfpInstance=x,e.default=k});