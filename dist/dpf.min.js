!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.DFP=t()}(this,function(){"use strict";function e(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.separator,i=void 0===n?";":n,r=t.operator,o=void 0===r?"=":r,a={},s=e.split(i);for(var u in s)if(s.hasOwnProperty(u)){var l=s[u].split(o);2==l.length&&(a[l[0]]=decodeURIComponent(l[1]))}return a}function t(t){var i=t||i,r=e(document.cookie,{separator:/;\s?/});return"string"==typeof r[i]&&(r[i]=e(r[i],{separator:":"})),console.log("map[ssoKey]:",n.typeof(r[i])),r}var n={};n.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},n.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();var i=window.location.hostname.indexOf("haaretz.com")>-1?"engsso":"tmsso",r={impressions:"impressions",frequency:"frequency",frequencyRegex:/(\d+)\/(\d+)(day|hour)/,expires:"expires",exposed:"exposed",maxImpressions:"maxImpressions",hours:"hour",days:"day"},o=function(){function e(t){n.classCallCheck(this,e),this.now=(new Date).getTime(),this.config=t,this.impressions=JSON.parse(localStorage.getItem(r.impressions)||"{}"),this.initImpressionMap()}return n.createClass(e,[{key:"saveImpressionsToLocalStorage",value:function(){localStorage.setItem(r.impressions,JSON.stringify(this.impressions))}},{key:"initImpressionMap",value:function(){var e=this;Object.keys(this.config).map(function(t,n){var i=t,o=void 0,a=!1;(o=e.impressions[i])?(e.config[i]=!o[r.frequency])?(a=!0,e.impressions[r.frequency]=e.config[i]):e.now>o[r.expires]&&(a=!0):e.initSlotFromConfig(i),a&&e.updateExpiryDate(i)})}},{key:"updateExpiryDate",value:function(e){function t(e,t){var n=new Date(e);return n.setHours(n.getHours()+t),n}function n(e,t){var n=new Date(e);return n.setDate(n.getDate()+t),n}var i=new Date,o=this.impressions[e][r.frequency].match(r.frequencyRegex);i.setMilliseconds(0),i.setSeconds(0),i.setMinutes(0),o.indexOf(r.days)>-1&&i.setHours(0),this.impressions[e][r.expires]=(o.indexOf(r.days)>-1?n(i,o[2]):t(i,o[2])).getTime(),this.impressions[e][r.maxImpressions]=o[1]}},{key:"initSlotFromConfig",value:function(e){var t=this.impressions[e]||{};t[r.frequency]=this.config[e],t[r.exposed]=0,this.impressions[e]=t,this.updateExpiryDate(e)}},{key:"registerImpression",value:function(e){return this.impressions[e][r.exposed]+=1,!0}},{key:"reachedQuota",value:function(e){var t=(new Date).getTime(),n=this.impressions[e][r.maxImpressions];return this.impressions[e][r.expires]<t&&this.impressions[e][r.exposed]<=n}}]),e}(),a={payer:"payer",registered:"registered",anonymous:"anonymous"},s=function(){function e(){n.classCallCheck(this,e),this.type=this.getUserType(),this.impressionManager=this.initImpressionMap()}return n.createClass(e,[{key:"getUserType",value:function(){var e=t();if(e&&e[i]){var n=i.indexOf("haaretz.com")>-1?"HdcPusr":"HtzPusr";return e[n]?a.payer:a.registered}return a.anonymous}},{key:"initImpressionMap",value:function(){var e={};return window.adUnitsFrequencyMap&&Object.keys(adUnitsFrequencyMap).map(function(t,n){e[t]=adUnitsFrequencyMap[t]}),new o(e)}}]),e}(),u=function(){function e(){n.classCallCheck(this,e),this.blockingQueue=this.initQueueFromJson()}return n.createClass(e,[{key:"initQueueFromJson",value:function(){var e=[],t=window.conflicManagementJson||window.conflictManagementJson||{};return Object.keys(t).map(function(n,i){var r=t[n];r&&(r=r.filter(function(e){return e.onsize&&e.avoid})),e.push({id:n,rules:r,resolvedWith:null})}),e}},{key:"updateResolvedSlot",value:function(e,t){if(!e)throw new Error("updateResolvedSlot must be called with an adSlotId!");if(!t)throw new Error("updateResolvedSlot must be called with a resolved size!");var n=!0,i=!1,r=void 0;try{for(var o,a=this.blockingQueue[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value;(s.id=e)&&(s.resolvedWith=t)}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}}},{key:"isBlocked",value:function e(t){if(!t)throw new Error("isBlocked must be called with an adSlotId!");var e=!1,n=!0,i=!1,r=void 0;try{for(var o,a=this.blockingQueue[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var s=o.value,u=!0,l=!1,c=void 0;try{for(var d,g=s.rules[Symbol.iterator]();!(u=(d=g.next()).done);u=!0){var f=d.value;f.avoid===t&&!function(){var t=s.resolvedWith;t||(e=!0),f.onsize.split(",").find(function(e){return e===t})&&(e=!0)}()}}catch(e){l=!0,c=e}finally{try{!u&&g.return&&g.return()}finally{if(l)throw c}}}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return e}}]),e}(),l={all:"all",nonPaying:"nonPaying",anonymous:"anonymous",registered:"registered",paying:"paying",digitalOnly:"digitalOnly",digitalAndPrint:"digitalAndPrint"},c={anonymous:"anonymous",registered:"registered",payer:"payer"},d={maavaron:".web.maavaron",popunder:".web.popunder",talkback:".web.fullbanner.talkback",regular:""},g={target:l.all,type:d.regular,responsive:!1,get department(){return window.isHomepage?"homepage":"section"}},f=function(){function e(t){n.classCallCheck(this,e),this.config=Object.assign({},g,t),this.referrerBlacklist=this.initReferrerBlacklist(),this.user=new s,this.conflictResolver=new u,this.adSlots=this.initAdSlots(),this.adSlotDefinitions=this.initAdSlotDefinitions()}return n.createClass(e,[{key:"initAdSlots",value:function(){var e=[],t=document.getElementsByClassName("js-dfp-ad");return Array.prototype.forEach.call(t,function(t,n){e.push({id:t.id,target:t.attributes["data-audtarget"].value,responsive:t.classList.contains("js-dfp-resp-refresh")})}),[]}},{key:"initReferrerBlacklist",value:function(){var e=[];return e.push("paid.outbrain.com"),e}},{key:"shouldSendRequestToDfp",value:function(e){return this.coflictResolver.isBlocked(e.id)===!1&&this.isMaavaron(e)===!1&&this.doesBreakpointContainAd()&&this.doesUserTypeMatchBannerTargeting(e)&&this.user.impressionManager.reachedQuota(e.id)===!1}},{key:"doesUserTypeMatchBannerTargeting",value:function(e){var t=this.user.type,n=e.target;switch(n){case l.all:return!0;case l.nonPaying:return t===c.anonymous||t===c.registered;case l.anonymous:return t===c.anonymous;case l.registered:return t===c.registered;case l.paying:return t===c.payer;case l.digitalOnly:return t===c.payer;case l.digitalAndPrint:return t===c.payer;default:return!1}}},{key:"isMaavaron",value:function(e){return e.id.indexOf(d.maavaron)>-1}},{key:"switchedToBreakpoint",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=this.adSlots[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;a.responsive===!0}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"doesBreakpointContainAd",value:function(){return!0}},{key:"initAdSlotDefinitions",value:function(){}},{key:"addSlotRenderedCallback",value:function(e){googletag.pubads().addEventListener("slotRenderEnded",e)}},{key:"initGoogleTargetingParams",value:function(){"undefined"!=typeof dfpUserType&&googletag.pubads().setTargeting("UserType",[dfpUserType]),"undefined"!=typeof dfpUrAe&&googletag.pubads().setTargeting("age",[dfpUrAe]),"undefined"!=typeof dfpStg&&googletag.pubads().setTargeting("stg",[dfpStg]),"undefined"!=typeof dfpUrGdr&&googletag.pubads().setTargeting("urgdr",[dfpUrGdr]),"undefined"!=typeof dfpArticleId&&googletag.pubads().setTargeting("articleId",[dfpArticleId]),"undefined"!=typeof CampaignNumber&&-1!=CampaignNumber&&googletag.pubads().setTargeting("gstat_campaign_id",[CampaignNumber]),"undefined"!=typeof utm_content&&null!=utm_content&&googletag.pubads().setTargeting("utm_content",[utm_content]),"undefined"!=typeof utm_source&&null!=utm_source&&googletag.pubads().setTargeting("utm_source",[utm_source]),"undefined"!=typeof utm_medium&&null!=utm_medium&&googletag.pubads().setTargeting("utm_medium",[utm_medium]),"undefined"!=typeof utm_campaign&&null!=utm_campaign&&googletag.pubads().setTargeting("utm_campaign",[utm_campaign])}}]),e}(),p={get isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent||"")},get isHomepage(){return"/"===window.location.pathname},get domain(){return window.location.hostname.replace(/([\w|\d]+.)/,"")},get articleId(){var e=/\d\.\d+/g.exec(window.location.pathname),t=null;return e&&(t=e.pop()),t},utm:{utm_content:"",utm_source:"",utm_medium:"",utm_campaign:""},adSlotConfig:{},adManagerConfig:{},userConfig:{age:"none",gender:"none"},sso:i},m=p||{},y=function(){function e(t){n.classCallCheck(this,e),this.config=Object.assign({},m,t),this.wasInitialized=!1,this.adManager=new f(t.adManagerConfig)}return n.createClass(e,[{key:"initGoogleTag",value:function(){var e=this,t=new Promise(function(t,n){1==e.wasInitialized?t():(window.googletag=window.googletag||{},window.googletag.cmd=window.googletag.cmd||[],function(){var e=this,i=document.createElement("script");i.async=!0,i.type="text/javascript",i.setAttribute("src","//www.googletagservices.com/tag/js/gpt.js");var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(i,r),i.onload=function(){e.wasInitialized=!0,t()},i.onerror=function(t){e.wasInitialized=!0,n(t)}}())});return t}},{key:"initGoogleGlobalSettings",value:function(){googletag.pubads().enableAsyncRendering(),googletag.enableServices()}}]),e}();return y.version="0.0.2",y});